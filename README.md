# Creating your own credentials.env and RAILS_MASTER_KEY

## How the credentials file works
Rails applications all you to keep essential secret values (such as "secret_key_base", database passwords, or API keys) in an encrypted file called `credentials.enc`.  Much like a personal password manager, this file can hold many secrets, but is unlocked by just one master password.  This allows you to store secrets -- and even commit them to version control -- safely, as long as you never commit the RAILS_MASTER_KEY.  

Then, deploying your app doesn't need to involve setting a lot of environment variables (ie `MY_DATABASE_PASSWORD`); you can just set  `RAILS_MASTER_KEY` and let the credentials file provide all the values inside.

For this demo app, rather than share my master key, I'm going to walk you through recreating the credentials file locally.

## Step 1: Delete Existing Credentials

First, remove the existing credentials file:

```
rm config/credentials.yml.enc
```

## Step 2: Generate a new secret_key_base
For the Elastic Beanstalk demo, the only secret value you need to set inside the credentials file is called `secret_key_base`.  You'll need a value for that key, which can be generated by running this.  Note that you'll need to have Rails installed locally for the next few commands.  Run the following and **copy this value to your clipboard**.
```
rails secret
```

## Step 4: Generate New Credentials and Master Key

Run the following command to generate a new credentials.enc file and a new master key.  You may substitute `vi` with your favorite command-line editor.

```
EDITOR="vi --wait" bin/rails credentials:edit
```

This will open a new credentials file in your specified editor.

## Step 5: Add secret_key_base to Credentials

In the opened file, add this line to set `secret_key_base`.

```
secret_key_base: <your_newly_generated_secret_key_base>
```

Save and quit.  Commit credentials.enc to your git repo.  **DO NOT commit config/master.key**.

## Step 6: Obtain (and push) your new master key 

You can view your new master key in plaintext in `config/master.key`.  If you are doing the Elastic Beanstalk tutorial, you can push it to your environment with this command:

```
eb setenv RAILS_MASTER_KEY=$(cat config/master.key)
```

If you have multiple EB environments, remember to include the name of your environment with `-e <environment_name>`.


# Building and Running Locally with Docker

Make sure you are running docker on your machine, then..

```
docker build -t my_art_gallery .
```

When that is complete, run it with this:
```
docker run -p 3000:3000 -e RAILS_MASTER_KEY=$(cat config/master.key) my_art_gallery
```

and access it at http://localhost:3000.

### `docker run` with ENV file

When you need to pass more than one or two environment variables into `docker run`, it's probably easier to use an ENV file.  Create the file `.env` and populate it like this:

```
VARIABLE=value
VARIABLE2=other_value
```

**DO NOT add `.env` to version control!** Then run docker like this:

```
docker run -p 3000:3000 --env-file .env my_art_gallery
```


# Optional: Local Dev Environment with Docker

**The following instructions are only for folks who want to run and modify the app locally!**

The default Dockerfile copies the app into the image, so if you run it locally as described above, you can't change the code and see those changes reflected; you'd have to rebuild the image with each code change.

If you want a local dev environment that runs through docker, that's what the `Dockerfile.localdev` file is for. 

These commands will build a version that expects a local volume mount, which is done by the `-v` parameter of the `docker run` command below. 

```
chmod +x entrypoint.localdev.sh
docker build -f Dockerfile.localdev -t my-rails-app-dev .
docker run -v $(pwd):/rails -p 3000:3000 my-rails-app-dev
```

Then you can navigate to http://localhost:3000, see the running app, and make changes locally that will be reflected instantly.  If you need to restart the server or run db:migrate, just re-run `docker run`, but if you change the Gemfile, you'll need to fully re-build the image with the steps above.